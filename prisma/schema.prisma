// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

enum UserRole {
  RESIDENT
  BARANGAY
  ADMIN
}

enum DonationStatus {
  SCHEDULED
  DISTRIBUTED
  CLAIMED
  CANCELLED
}

enum ClaimStatus {
  PENDING
  VERIFIED
  CLAIMED
  REJECTED
}

enum FamilyMemberRelation {
  SPOUSE
  CHILD
  PARENT
  SIBLING
  OTHER
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum ResidencyCategory {
  BONAFIDE_RESIDENT
  BONAFIDE_RESIDENT_IP
  TRANSIENT_RESIDENT
  TRANSFERRED_RESIDENT
}

enum EducationalAttainment {
  NO_FORMAL_EDUCATION
  ELEMENTARY_LEVEL
  ELEMENTARY_GRADUATE
  HIGH_SCHOOL_LEVEL
  HIGH_SCHOOL_GRADUATE
  SENIOR_HIGH_SCHOOL
  VOCATIONAL_TESDA
  COLLEGE_LEVEL
  COLLEGE_GRADUATE
  POST_GRADUATE
}

enum HousingType {
  OWNED
  RENTED
  SHARED
}

enum EmploymentType {
  PERMANENT
  CONTRACTUAL
  PART_TIME
  SEASONAL
  UNEMPLOYED
}

enum AnnualIncome {
  BELOW_50000
  BETWEEN_50000_100000
  BETWEEN_100001_200000
  ABOVE_200000
}

enum MaritalStatus {
  SINGLE
  MARRIED
  WIDOWED
  SOLO_PARENT
}

enum FamilyClassification {
  HIGH_CLASS
  MIDDLE_CLASS
  LOW_CLASS
  UNCLASSIFIED
}

enum DonationType {
  GENERAL
  EDUCATION
  WHEELCHAIR
  PWD
  IP
  SENIOR_CITIZEN
  SOLO_PARENT
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  phone     String?
  role      UserRole @default(RESIDENT)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Resident specific fields
  barangayId String?
  barangay   Barangay? @relation(fields: [barangayId], references: [id])
  
  // Personal Information
  gender      Gender?
  dateOfBirth DateTime?
  purok       String?  // Purok/Sitio
  municipality String? // Municipality
  
  // Residency Category
  residencyCategory ResidencyCategory?
  
  // Educational Background
  educationalAttainment EducationalAttainment?
  lastSchoolAttended   String?
  yearLastAttended     String?
  
  // Household Information
  numberOfHouseholdMembers Int?
  numberOfDependents       Int?
  isHeadOfFamily           Boolean? @default(false)
  housingType              HousingType?
  barangayCertificatePath  String?  // Barangay Certificate of Residency
  
  // Occupational and Income Information
  sourceOfIncome     String?
  employmentType     EmploymentType?
  estimatedAnnualIncome AnnualIncome?
  lowIncomeCertPath  String?  // Certificate of Low Income
  employmentCertPath String?  // Certificate of Employment or Payslip
  businessPermitPath String?  // Business Permit
  
  // Civil and Social Status
  maritalStatus      MaritalStatus?
  marriageContractPath String?  // Marriage Contract
  soloParentIdPath   String?    // Solo Parent ID
  seniorCitizenIdPath String?   // Senior Citizen ID
  pwdIdPath          String?    // PWD ID
  ipCertificatePath String?     // Certificate of Indigency / Tribal Certificate
  schoolIdPath       String?     // School ID or Certificate of Enrollment
  outOfSchoolYouthCertPath String? // Certificate from Barangay or DSWD
  
  // Supporting Documents
  barangayClearancePath String?  // Barangay Clearance (latest)
  certificateOfIndigencyPath String? // Certificate of Indigency
  proofOfResidencyPath String?  // Proof of Residency
  
  // Valid ID (existing)
  idFilePath String?   // Path to uploaded ID file (front & back)
  idBackFilePath String? // Path to uploaded ID back
  
  // Family Classification (for barangay managers)
  familyClassification FamilyClassification? @default(UNCLASSIFIED)
  
  families   Family[]
  claims     Claim[] @relation("ClaimedByUser")
  verifiedClaims Claim[] @relation("VerifiedByUser")

  // Barangay specific fields
  managedBarangay Barangay? @relation("BarangayManager")

  // Audit logs
  auditLogs AuditLog[]

  // NextAuth relations
  accounts Account[]
  sessions Session[]

  @@map("users")
}

model Barangay {
  id          String   @id @default(cuid())
  name        String
  code        String   @unique
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  managerId String? @unique
  manager   User?   @relation("BarangayManager", fields: [managerId], references: [id])
  residents User[]
  families  Family[]
  schedules DonationSchedule[]
  claims    Claim[]

  @@map("barangays")
}

model Family {
  id         String   @id @default(cuid())
  headId     String
  head       User     @relation(fields: [headId], references: [id])
  barangayId String
  barangay   Barangay @relation(fields: [barangayId], references: [id])
  address    String
  createdAt  DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  members FamilyMember[]
  claims  Claim[]

  @@map("families")
}

model FamilyMember {
  id       String                @id @default(cuid())
  familyId String
  family   Family                @relation(fields: [familyId], references: [id])
  name     String
  relation FamilyMemberRelation
  age      Int?
  createdAt DateTime @default(now())

  @@map("family_members")
}

model DonationSchedule {
  id          String         @id @default(cuid())
  barangayId  String
  barangay    Barangay       @relation(fields: [barangayId], references: [id])
  title       String
  description String?
  date        DateTime
  startTime   String
  endTime     String
  location    String
  maxRecipients Int?
  status      DonationStatus @default(SCHEDULED)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // Classification and Type filtering
  targetClassification FamilyClassification? // null means "all classes"
  type                 DonationType          @default(GENERAL)

  // Relations
  claims Claim[]

  @@map("donation_schedules")
}

model Claim {
  id         String         @id @default(cuid())
  familyId   String
  family     Family         @relation(fields: [familyId], references: [id])
  scheduleId String
  schedule   DonationSchedule @relation(fields: [scheduleId], references: [id])
  claimedBy  String
  claimedByUser User        @relation("ClaimedByUser", fields: [claimedBy], references: [id])
  barangayId String
  barangay   Barangay       @relation(fields: [barangayId], references: [id])
  status     ClaimStatus    @default(PENDING)
  isVerified Boolean        @default(false)
  claimedAt  DateTime       @default(now())
  verifiedAt DateTime?
  claimedAtPhysical DateTime?
  notes      String?
  verifiedBy String?
  verifiedByUser User?      @relation("VerifiedByUser", fields: [verifiedBy], references: [id])

  @@unique([familyId, scheduleId])
  @@map("claims")
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  action    String
  details   String?
  createdAt DateTime @default(now())

  @@map("audit_logs")
}

model FAQ {
  id        String   @id @default(cuid())
  question  String
  answer    String
  order     Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("faqs")
}

model ContactInfo {
  id        String   @id @default(cuid())
  type      String   // email, phone, address
  value     String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("contact_info")
}

// NextAuth.js required models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model SMSSettings {
  id       String   @id @default(cuid())
  username String
  password String
  isActive Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("sms_settings")
}